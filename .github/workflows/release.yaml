name: Release

on:
  release:
    types:
      - published  # Runs only when a release is published

permissions:
  contents: write  # Grant write permissions to GITHUB_TOKEN
  id-token: write  # Required for Workload Identity Federation

jobs:
  validate_gradle_wrapper:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Gradle Wrapper Validation
        uses: gradle/actions/wrapper-validation@v5

  release:
    needs: [validate_gradle_wrapper]
    environment: deployment
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write  # Required for Workload Identity Federation
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Authenticate to Google Cloud for GCS/KMS
        id: auth_gcs
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Download file from GCS
        run: |
          gcloud auth login --cred-file="$GOOGLE_APPLICATION_CREDENTIALS"
          gsutil -q cp gs://${{ secrets.SOLANA_GCS_BUCKET }}/encrypted_gpg.kms encrypted_gpg.kms

      - name: Decrypt file using KMS
        run: |
          gcloud kms decrypt \
            --key gpg \
            --keyring gpg \
            --location global \
            --plaintext-file private.pgp \
            --ciphertext-file encrypted_gpg.kms

      - name: Import GPG
        run: |
          gpg --import private.pgp

      - name: Set up Java
        uses: ./.github/actions/setup-java
      - name: Set up Gradle
        uses: ./.github/actions/setup-gradle
        with:
          gradle-home-cache-cleanup: true
      - name: Export Google Services JSON
        env:
          FIREBASE_DEBUG_JSON_BASE64: ${{ secrets.FIREBASE_DEBUG_JSON_BASE64 }}
          FIREBASE_RELEASE_JSON_BASE64: ${{ secrets.FIREBASE_RELEASE_JSON_BASE64 }}
        if: "${{ env.FIREBASE_DEBUG_JSON_BASE64 != '' && env.FIREBASE_RELEASE_JSON_BASE64 != '' }}"
        shell: bash
        run: |
          mkdir -p app/src/debug/
          mkdir -p app/src/release/
          echo ${FIREBASE_DEBUG_JSON_BASE64} | base64 --decode > app/src/debug/google-services.json
          echo ${FIREBASE_RELEASE_JSON_BASE64} | base64 --decode > app/src/release/google-services.json
      - name: Export Signing Key
        env:
          # The upload key must be exported using `base64 -w 0 <filename.jks>` for use
          # as a Github Secrets value; if the key is exported with standard wrapping,
          # it will fail to import correctly.
          # NOTE: This is the upload signing key, which may be replaced at will, not
          # the application signing key which is escrowed by Google and may only be
          # replaced once a year (and has a bunch of additional hassles associated with
          # replacing it.)
          SIGNING_KEYSTORE_BASE_64: ${{ secrets.UPLOAD_KEYSTORE_BASE_64 }}
        shell: bash
        run: |
          echo ${SIGNING_KEYSTORE_BASE_64} | base64 --decode > ${{ runner.temp }}/release.jks

      - name: Build Store (Google play) APK
        env:
          # TODO [#1033]: Use token-based authorization on Google Play for automated deployment
          # TODO [#1033]: https://github.com/Electric-Coin-Company/zashi-android/issues/1033
          # Note that these properties are not currently used due to #1033
          # ORG_GRADLE_PROJECT_ZCASH_GOOGLE_PLAY_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
          # ORG_GRADLE_PROJECT_ZCASH_GOOGLE_PLAY_SERVICE_KEY_FILE_PATH: ${{ steps.auth_google_play.outputs.credentials_file_path }}
          ORG_GRADLE_PROJECT_ZCASH_GOOGLE_PLAY_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_KEY }}
          ORG_GRADLE_PROJECT_ZCASH_GOOGLE_PLAY_PUBLISHER_API_KEY: ${{ secrets.GOOGLE_PLAY_PUBLISHER_API_KEY }}
          ORG_GRADLE_PROJECT_ZCASH_GOOGLE_PLAY_DEPLOY_TRACK: internal
          ORG_GRADLE_PROJECT_ZCASH_GOOGLE_PLAY_DEPLOY_STATUS: completed
          ORG_GRADLE_PROJECT_ZCASH_RELEASE_KEYSTORE_PATH: ${{ runner.temp }}/release.jks
          ORG_GRADLE_PROJECT_ZCASH_RELEASE_KEYSTORE_PASSWORD: ${{ secrets.UPLOAD_KEYSTORE_PASSWORD }}
          ORG_GRADLE_PROJECT_ZCASH_RELEASE_KEY_ALIAS: ${{ secrets.UPLOAD_KEY_ALIAS }}
          ORG_GRADLE_PROJECT_ZCASH_RELEASE_KEY_ALIAS_PASSWORD: ${{ secrets.UPLOAD_KEY_ALIAS_PASSWORD }}
          ORG_GRADLE_PROJECT_ZCASH_FLEXA_KEY: ${{ secrets.FLEXA_PUBLISHABLE_KEY }}
          ORG_GRADLE_PROJECT_ZCASH_CMC_KEY: ${{ secrets.CMC_PUBLISHABLE_KEY }}
        run: |
          ./gradlew clean :app:bundleZcashmainnetStoreRelease :app:packageZcashmainnetStoreReleaseUniversalApk

      - name: Prepare Store (Google play) Artifacts
        run: |
          mkdir artifacts/
          mv app/build/outputs/apk_from_bundle/*/app-zcashmainnet-store-release-universal.apk artifacts/app-zcashmainnet-google-play-store-release-universal.apk

      - name: Strip non-FOSS libraries
        uses: ./.github/actions/foss/strip

      - name: Build FOSS (externallibs) APK
        env:
          ORG_GRADLE_PROJECT_ZCASH_RELEASE_KEYSTORE_PATH: ${{ runner.temp }}/release.jks
          ORG_GRADLE_PROJECT_ZCASH_RELEASE_KEYSTORE_PASSWORD: ${{ secrets.UPLOAD_KEYSTORE_PASSWORD }}
          ORG_GRADLE_PROJECT_ZCASH_RELEASE_KEY_ALIAS: ${{ secrets.UPLOAD_KEY_ALIAS }}
          ORG_GRADLE_PROJECT_ZCASH_RELEASE_KEY_ALIAS_PASSWORD: ${{ secrets.UPLOAD_KEY_ALIAS_PASSWORD }}
          ORG_GRADLE_PROJECT_ZCASH_FLEXA_KEY: ${{ secrets.FLEXA_PUBLISHABLE_KEY }}
          ORG_GRADLE_PROJECT_ZCASH_CMC_KEY: ${{ secrets.CMC_PUBLISHABLE_KEY }}
        run: |
          ./gradlew clean :app:assembleZcashmainnetFossRelease

      - name: Prepare FOSS (externallibs) Artifacts
        run: |
          mv app/build/outputs/apk/zcashmainnetFoss/release/app-zcashmainnet-foss-release.apk artifacts/app-zcashmainnet-foss-release-full-externallibs.apk

      - name: Build FOSS (F-Droid) APK
        env:
          ORG_GRADLE_PROJECT_ZCASH_RELEASE_KEYSTORE_PATH: ${{ runner.temp }}/release.jks
          ORG_GRADLE_PROJECT_ZCASH_RELEASE_KEYSTORE_PASSWORD: ${{ secrets.UPLOAD_KEYSTORE_PASSWORD }}
          ORG_GRADLE_PROJECT_ZCASH_RELEASE_KEY_ALIAS: ${{ secrets.UPLOAD_KEY_ALIAS }}
          ORG_GRADLE_PROJECT_ZCASH_RELEASE_KEY_ALIAS_PASSWORD: ${{ secrets.UPLOAD_KEY_ALIAS_PASSWORD }}
          # ORG_GRADLE_PROJECT_ZCASH_FLEXA_KEY: ${{ secrets.FLEXA_PUBLISHABLE_KEY }}
          # ORG_GRADLE_PROJECT_ZCASH_CMC_KEY: ${{ secrets.CMC_PUBLISHABLE_KEY }}
        run: |
          ./gradlew clean :app:assembleZcashmainnetFossRelease

      - name: Prepare FOSS (F-Droid) artifacts
        run: |
          mv app/build/outputs/apk/zcashmainnetFoss/release/app-zcashmainnet-foss-release.apk artifacts/

      - name: Prepare Signature artifacts
        run: |
          cd artifacts/
          TAG=$(git describe --tags --abbrev=0)
          VERSION_CODE=$(echo "$TAG" | cut -d'-' -f2)
          echo $VERSION_CODE > version_code.txt
          gpg -u sysadmin@z.cash --armor --digest-algo SHA256 --detach-sign app-zcashmainnet-foss-release.apk
          gpg -u sysadmin@z.cash --armor --digest-algo SHA256 --detach-sign app-zcashmainnet-foss-release-full-externallibs.apk
          gpg -u sysadmin@z.cash --armor --digest-algo SHA256 --detach-sign app-zcashmainnet-google-play-store-release-universal.apk

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish_to_solana:
    needs: [release]
    environment: deployment
    continue-on-error: true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write  # Required for Workload Identity Federation
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Get release tag
        id: release_info
        run: |
          TAG=$(git describe --tags --abbrev=0)
          VERSION_NAME=$(echo "$TAG" | sed 's/^v//' | cut -d'-' -f1)
          VERSION_CODE=$(echo "$TAG" | cut -d'-' -f2)

          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "version_name=${VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "version_code=${VERSION_CODE}" >> $GITHUB_OUTPUT

          echo "Release Tag: ${TAG}"
          echo "Version Name: ${VERSION_NAME}"
          echo "Version Code: ${VERSION_CODE}"

      - name: Download Release APK
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.release_info.outputs.tag }}"

          mkdir -p stores/solana

          gh release download "${TAG}" \
            -p "app-zcashmainnet-foss-release-full-externallibs.apk" \
            -D stores/solana/

          mv stores/solana/app-zcashmainnet-foss-release-full-externallibs.apk \
             stores/solana/solana.apk

          echo "APK downloaded and renamed to solana.apk"
          ls -lh stores/solana/solana.apk

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Download encrypted files from GCS
        run: |
          gcloud auth login --cred-file="$GOOGLE_APPLICATION_CREDENTIALS"

          echo "Downloading encrypted files from gs://${{ secrets.SOLANA_GCS_BUCKET }}/"

          gsutil cp gs://${{ secrets.SOLANA_GCS_BUCKET }}/encrypted_solana_keypair.kms /tmp/encrypted_solana_keypair.kms
          gsutil cp gs://${{ secrets.SOLANA_GCS_BUCKET }}/encrypted_config.yaml.kms /tmp/encrypted_config.yaml.kms

          echo "Files downloaded"

      - name: Decrypt files using Cloud KMS
        run: |
          echo "Decrypting Solana keypair..."
          gcloud kms decrypt \
            --key=gpg \
            --keyring=gpg \
            --location=global \
            --plaintext-file=/tmp/solana-keypair.json \
            --ciphertext-file=/tmp/encrypted_solana_keypair.kms \
            --project=${{ secrets.GCP_PROJECT_ID_PROD }}

          echo "Decrypting config.yaml..."
          gcloud kms decrypt \
            --key=config \
            --keyring=gpg \
            --location=global \
            --plaintext-file=/tmp/config.yaml \
            --ciphertext-file=/tmp/encrypted_config.yaml.kms \
            --project=${{ secrets.GCP_PROJECT_ID_PROD }}

          echo "Files decrypted"

          # Validate JSON and YAML
          jq empty /tmp/solana-keypair.json || { echo "Invalid JSON in keypair"; exit 1; }
          yq eval '.' /tmp/config.yaml > /dev/null || { echo "Invalid YAML in config"; exit 1; }

      - name: Prepare config in stores directory
        run: |
          cp /tmp/config.yaml stores/solana/config.yaml
          echo "Config copied to stores/solana/config.yaml"

      - name: Update config.yaml with release information
        run: |
          chmod +x .github/scripts/update-solana-config-from-gcs.sh

          .github/scripts/update-solana-config-from-gcs.sh \
            "${{ steps.release_info.outputs.version_name }}" \
            "${{ steps.release_info.outputs.version_code }}" \
            "stores/solana/config.yaml" \
            "stores/solana/release-notes-template.yaml" \
            "docs/whatsNew/WHATS_NEW_EN.md"

      - name: Create Solana dApp Store Release
        working-directory: stores/solana
        run: |
          echo "Creating release on Solana dApp Store..."

          npx @solana-mobile/dapp-store-cli@latest create release \
            -k /tmp/solana-keypair.json \
            -b $ANDROID_SDK_ROOT/build-tools/35.0.0 \
            -u https://api.mainnet-beta.solana.com \
            --config config.yaml

          echo "Release created successfully"

      - name: Publish Update to Solana dApp Store
        working-directory: stores/solana
        run: |
          echo "Publishing update to Solana dApp Store..."

          npx @solana-mobile/dapp-store-cli@latest publish update \
            -k /tmp/solana-keypair.json \
            -u https://api.mainnet-beta.solana.com \
            --complies-with-solana-dapp-store-policies \
            --requestor-is-authorized \
            --config config.yaml

          echo "Update published successfully"

      - name: Display publish information
        working-directory: stores/solana
        run: |
          echo "Solana dApp Store Publishing Complete"
          echo "Release Address: $(yq eval '.release.address' config.yaml)"
          echo "Version: $(yq eval '.release.android_details.version' config.yaml)"
          echo "Version Code: $(yq eval '.release.android_details.version_code' config.yaml)"

      - name: Re-encrypt and upload config.yaml to GCS
        run: |
          echo "Creating backup of current config..."
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          gsutil cp gs://${{ secrets.SOLANA_GCS_BUCKET }}/encrypted_config.yaml.kms \
            gs://${{ secrets.SOLANA_GCS_BUCKET }}/backups/encrypted_config.yaml.kms.${TIMESTAMP} || \
            echo "Warning: Could not create backup"

          echo "Re-encrypting config.yaml..."
          gcloud kms encrypt \
            --key=config \
            --keyring=gpg \
            --location=global \
            --plaintext-file=stores/solana/config.yaml \
            --ciphertext-file=/tmp/encrypted_config_new.yaml.kms \
            --project=${{ secrets.GCP_PROJECT_ID_PROD }}

          echo "Uploading to GCS..."
          gsutil cp /tmp/encrypted_config_new.yaml.kms \
            gs://${{ secrets.SOLANA_GCS_BUCKET }}/encrypted_config.yaml.kms

          echo "Config updated in GCS"
          echo "Backup: gs://${{ secrets.SOLANA_GCS_BUCKET }}/backups/encrypted_config.yaml.kms.${TIMESTAMP}"
